<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>MonitorizaciÃ³n en Tiempo Real</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <%- include("partials/header") %>

  <main style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:80vh;background:#f9f9f9;">
    <div style="position:relative;max-width:900px;width:100%;border-radius:8px;overflow:hidden;box-shadow:0 0 10px rgba(0,0,0,0.2);">
      <video id="preview" autoplay playsinline muted style="width:100%;height:auto;background:#000;"></video>
    </div>

    <div style="margin-top:20px;">
      <button id="startBtn" style="padding:10px 20px;">ğŸ¥ Iniciar GrabaciÃ³n</button>
      <button id="stopBtn" style="padding:10px 20px;display:none;">â¹ï¸ Detener y Subir</button>
    </div>

    <div id="status" style="margin-top:15px;color:#333;font-weight:bold;"></div>
  </main>

  <script>
    const video = document.getElementById('preview');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');

    let mediaRecorder;
    let chunks = [];

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        video.srcObject = stream;
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });

        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) chunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
          const blob = new Blob(chunks, { type: 'video/mp4' });
          chunks = [];

          statusEl.textContent = "â« Subiendo video a S3...";

          try {
            const res = await fetch('/subir-video', {
              method: 'POST',
              headers: { 'Content-Type': 'video/mp4' },
              body: blob
            });

            const data = await res.json();
            if (data.ok) {
              statusEl.textContent = "âœ… Video subido correctamente a S3: " + data.nombreArchivo;
            } else {
              statusEl.textContent = "âŒ Error al subir video: " + (data.error || 'desconocido');
            }
          } catch (err) {
            console.error(err);
            statusEl.textContent = "âš ï¸ Error al subir video al servidor.";
          }
        };
      } catch (err) {
        console.error("Error al acceder a la cÃ¡mara:", err);
        statusEl.textContent = "âš ï¸ No se pudo acceder a la cÃ¡mara.";
      }
    }

    startBtn.addEventListener('click', () => {
      if (!mediaRecorder) {
        alert("La cÃ¡mara no estÃ¡ lista aÃºn.");
        return;
      }
      mediaRecorder.start();
      statusEl.textContent = "ğŸ¬ Grabando...";
      startBtn.style.display = "none";
      stopBtn.style.display = "inline-block";
    });

    stopBtn.addEventListener('click', () => {
      mediaRecorder.stop();
      statusEl.textContent = "ğŸ“¦ Procesando video...";
      stopBtn.style.display = "none";
      startBtn.style.display = "inline-block";
    });

    startCamera();
  </script>
</body>
</html>
